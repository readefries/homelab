# CronJob to sync TLS certificates from Traefik's acme.json to Kubernetes secrets
# This allows stunnel and other services to use Traefik-managed Let's Encrypt certs
apiVersion: v1
kind: ServiceAccount
metadata:
  name: cert-sync
  namespace: dns-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cert-sync
  namespace: dns-system
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "create", "update", "patch"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "patch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cert-sync
  namespace: dns-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: cert-sync
subjects:
  - kind: ServiceAccount
    name: cert-sync
    namespace: dns-system
---
# Also need access to read the Traefik PVC
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: cert-sync-traefik
  namespace: traefik
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]
  - apiGroups: [""]
    resources: ["pods/exec"]
    verbs: ["create"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: cert-sync-traefik
  namespace: traefik
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: cert-sync-traefik
subjects:
  - kind: ServiceAccount
    name: cert-sync
    namespace: dns-system
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: cert-sync-script
  namespace: dns-system
data:
  sync-certs.sh: |
    #!/bin/bash
    set -e
    
    CERTS_CHANGED=false
    
    # Get the Traefik pod name
    TRAEFIK_POD=$(kubectl get pods -n traefik -l app=traefik -o jsonpath='{.items[0].metadata.name}')
    
    if [ -z "$TRAEFIK_POD" ]; then
      echo "ERROR: Could not find Traefik pod"
      exit 1
    fi
    
    echo "Found Traefik pod: $TRAEFIK_POD"
    
    # Get acme.json content
    ACME_JSON=$(kubectl exec -n traefik "$TRAEFIK_POD" -- cat /data/acme.json 2>/dev/null)
    
    if [ -z "$ACME_JSON" ]; then
      echo "ERROR: Could not read acme.json"
      exit 1
    fi
    
    # Function to extract and create secret for a domain
    extract_cert() {
      local domain=$1
      local secret_name=$2
      
      echo "Extracting certificate for $domain..."
      
      # Extract certificate and key from acme.json
      CERT=$(echo "$ACME_JSON" | jq -r --arg domain "$domain" \
        '.letsencrypt.Certificates[] | select(.domain.main == $domain) | .certificate' | base64 -d)
      KEY=$(echo "$ACME_JSON" | jq -r --arg domain "$domain" \
        '.letsencrypt.Certificates[] | select(.domain.main == $domain) | .key' | base64 -d)
      
      if [ -z "$CERT" ] || [ -z "$KEY" ]; then
        echo "WARNING: Certificate not found for $domain"
        return 1
      fi
      
      # Get current cert from secret (if exists)
      CURRENT_CERT=$(kubectl get secret "$secret_name" -n dns-system -o jsonpath='{.data.tls\.crt}' 2>/dev/null | base64 -d || echo "")
      
      # Compare certificates
      if [ "$CERT" = "$CURRENT_CERT" ]; then
        echo "Certificate for $domain unchanged"
        return 0
      fi
      
      # Create or update the secret
      kubectl create secret tls "$secret_name" \
        --namespace=dns-system \
        --cert=<(echo "$CERT") \
        --key=<(echo "$KEY") \
        --dry-run=client -o yaml | kubectl apply -f -
      
      echo "Certificate updated for $secret_name"
      CERTS_CHANGED=true
    }
    
    # Sync certificates
    extract_cert "dns.xs4some.nl" "dot-standard-tls"
    extract_cert "kids.xs4some.nl" "dot-kids-tls"
    
    # Restart dot-proxy only if certificates changed
    if [ "$CERTS_CHANGED" = true ]; then
      echo "Certificates changed, restarting dot-proxy deployment..."
      kubectl rollout restart deployment/dot-proxy -n dns-system
      kubectl rollout status deployment/dot-proxy -n dns-system --timeout=60s
    else
      echo "No certificate changes, skipping restart"
    fi
    
    echo "Certificate sync completed!"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: cert-sync
  namespace: dns-system
spec:
  schedule: "0 */12 * * *"  # Every 12 hours
  successfulJobsHistoryLimit: 1
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: cert-sync
          restartPolicy: OnFailure
          containers:
          - name: cert-sync
            image: bitnami/kubectl:latest
            command: ["/bin/bash", "/scripts/sync-certs.sh"]
            volumeMounts:
            - name: script
              mountPath: /scripts
          volumes:
          - name: script
            configMap:
              name: cert-sync-script
              defaultMode: 0755
---
# Run the sync job immediately 
apiVersion: batch/v1
kind: Job
metadata:
  name: cert-sync-initial
  namespace: dns-system
spec:
  template:
    spec:
      serviceAccountName: cert-sync
      restartPolicy: OnFailure
      containers:
      - name: cert-sync
        image: bitnami/kubectl:latest
        command: ["/bin/bash", "/scripts/sync-certs.sh"]
        volumeMounts:
        - name: script
          mountPath: /scripts
      volumes:
      - name: script
        configMap:
          name: cert-sync-script
          defaultMode: 0755
